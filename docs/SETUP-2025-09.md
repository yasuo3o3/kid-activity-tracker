# Supabase セットアップ手順（2025年9月版）

❗ **2025年9月時点のSupabase新UIで実際に動作確認済み**の手順です。古い記事と画面名称・エンドポイントが異なります。

## 目的

子ども向けPWA「Kid Activity Tracker」を構築するためのSupabaseバックエンド設定。以下の機能を実装：

- 子どもが「勉強/遊び/休憩」を **ワンタップで申告**
- 親（管理者）が **今日/昨日/今月** の累計時間を **即時反映** で確認
- 通知は **Pushover** へ送信
- **Edge Functions** で状態切替とPushover通知を処理

## 前提条件

- Windows (PowerShell/Git Bash) 環境
- Supabaseアカウント作成済み
- Pushoverアプリ購入済み（通知が不要な場合はスキップ可）

## 1. Supabaseプロジェクト作成

1. [Supabase Console](https://supabase.com/dashboard) にログイン
2. 「New project」をクリック
3. プロジェクト名・パスワード・リージョンを設定

## 2. API設定の取得

### Project Settings → API
1. 左サイドバーから「Project Settings」をクリック
2. 「API」セクションを選択
3. 以下の値を控える：
   - **Project URL** (例: `https://zrqvlbkerfugthzobrog.supabase.co`)
   - **anon key** (public key) - フロント用
   - **service_role key** - Edge Functions用（フロントでは使用禁止）

❗ **エンドポイント注意**: Edge Functionsのエンドポイントは `/functions/v1/<name>` です。古い記事の `/functions/<name>` は誤りです。

## 3. Functions Secrets 設定

### Project Settings → Functions → Secrets
1. 左サイドバーから「Project Settings」をクリック
2. 「Functions」セクションを選択
3. 「Secrets」タブをクリック
4. 以下のキーを追加：

❗ **重要**: `SUPABASE_` プレフィックスは使用不可（エラーになります）

```env
DB_URL=https://xxxx.supabase.co
SERVICE_ROLE_KEY=eyJ...（service_role keyを貼り付け）
PUSHOVER_APP_TOKEN=a...（Pushoverアプリトークン）
PUSHOVER_USER_KEY=u...（Pushoverユーザーキー）
```

**Pushover設定（通知が必要な場合）:**
- [Pushover Console](https://pushover.net/) でアプリ作成
- `PUSHOVER_APP_TOKEN`: アプリの API Token
- `PUSHOVER_USER_KEY`: Your User Key（個人用）または Group Key（複数親用）

## 4. データベーススキーマ作成

### SQL Editor で実行
1. 左サイドバーから「SQL Editor」をクリック
2. 以下のSQLを貼り付けて実行：

```sql
-- kids テーブル作成
create table if not exists public.kids (
  id uuid primary key default gen_random_uuid(),
  display_name text not null,
  pin text,
  archived boolean not null default false,
  created_at timestamptz not null default now()
);

-- sessions テーブル作成
create table if not exists public.sessions (
  id uuid primary key default gen_random_uuid(),
  kid_id uuid not null references public.kids(id) on delete cascade,
  label text not null check (label in ('study','play','break')),
  started_at timestamptz not null,
  ended_at timestamptz,
  created_at timestamptz not null default now()
);

-- インデックス作成
create index if not exists idx_sessions_kid_started on public.sessions (kid_id, started_at desc);
create index if not exists idx_sessions_open on public.sessions (kid_id) where ended_at is null;

-- RLS（Row Level Security）を有効化
alter table public.kids enable row level security;
alter table public.sessions enable row level security;
```

❗ **Security Advisor の赤い警告について**: RLS を有効化（`enable row level security`）することで解消されます。細かいポリシーは後日設定でも構いません。Edge Functions は `service_role` キーでバイパスします。

## 5. Edge Functions 作成

### 新UI での作成手順
1. 左サイドバーから「Edge Functions」をクリック
2. 「Deploy a new function」ボタンをクリック
3. 「Via Editor」を選択
4. Function name を入力
5. エディタに TypeScript コードを貼り付け
6. 右上の「Deploy」ボタンをクリック
7. ダイアログの「Deploy updates」をクリック

**成功判定:**
- 右上に緑色のトーストが表示される
- Details の「Last updated at」が現在時刻になる
- Deployments のカウントが増える

### 5-1. switch Function（状態切替 + 通知）

**Function name:** `switch`

```ts
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "npm:@supabase/supabase-js@2";

const DB_URL = Deno.env.get("DB_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SERVICE_ROLE_KEY")!;
const PUSHOVER_APP_TOKEN = Deno.env.get("PUSHOVER_APP_TOKEN") ?? "";
const PUSHOVER_USER_KEY = Deno.env.get("PUSHOVER_USER_KEY") ?? "";

const supabase = createClient(DB_URL, SERVICE_ROLE_KEY, { auth: { persistSession: false } });
const LABELS = ["study","play","break"] as const;
const SAME_LABEL_COOLDOWN_SEC = 60;

Deno.serve(async (req) => {
  try {
    const { kid_id, label } = await req.json();
    if (!kid_id || !LABELS.includes(label)) return j({ ok:false, error:"bad request" }, 400);

    // 進行中のセッションを取得
    const { data: openRows, error: openErr } = await supabase
      .from("sessions").select("id,label,started_at")
      .eq("kid_id", kid_id).is("ended_at", null)
      .order("started_at", { ascending:false }).limit(1);
    if (openErr) return j({ ok:false, error:openErr.message }, 500);

    const nowIso = new Date().toISOString();

    // 既存セッションのクローズ処理と連打ガード
    if (openRows?.length) {
      const open = openRows[0];
      const within = (Date.now() - new Date(open.started_at).getTime())/1000 < SAME_LABEL_COOLDOWN_SEC;
      if (open.label === label && within) return j({ ok:false, error:"too soon" }, 409);
      const { error: closeErr } = await supabase.from("sessions").update({ ended_at: nowIso }).eq("id", open.id);
      if (closeErr) return j({ ok:false, error:closeErr.message }, 500);
    }

    // 新規セッション開始
    const { data: ins, error: insErr } = await supabase
      .from("sessions").insert([{ kid_id, label, started_at: nowIso }])
      .select("started_at").single();
    if (insErr) return j({ ok:false, error:insErr.message }, 500);

    // 子どもの表示名取得（通知用）
    const { data: kid } = await supabase.from("kids").select("display_name").eq("id", kid_id).single();
    const display = kid?.display_name ?? kid_id;

    // Pushover通知送信
    if (PUSHOVER_APP_TOKEN && PUSHOVER_USER_KEY) {
      const ja = label === "study" ? "勉強" : label === "play" ? "遊び" : "休憩";
      const time = toJstHHmm(new Date());
      await fetch("https://api.pushover.net/1/messages.json", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          token: PUSHOVER_APP_TOKEN,
          user: PUSHOVER_USER_KEY,
          title: "Kid Activity Tracker",
          message: `${display} は ${ja} を開始（${time}）`,
          priority: "0",
        }),
      }).catch(() => {}); // エラー時は無視
    }

    return j({ ok:true, current:{ label, started_at: ins.started_at } });
  } catch (e) {
    return j({ ok:false, error:String(e) }, 500);
  }
});

function j(body: unknown, status=200) {
  return new Response(JSON.stringify(body), { status, headers:{ "content-type":"application/json" }});
}
function toJstHHmm(d: Date) {
  const j = new Date(d.getTime() + 9*3600_000);
  const hh = String(j.getUTCHours()).padStart(2,"0");
  const mm = String(j.getUTCMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
```

### 5-2. stats Function（統計取得）

**Function name:** `stats`

```ts
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "npm:@supabase/supabase-js@2";

const DB_URL = Deno.env.get("DB_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SERVICE_ROLE_KEY")!;
const supabase = createClient(DB_URL, SERVICE_ROLE_KEY, { auth: { persistSession: false } });

function jstRanges(nowUtc = new Date()) {
  const toJstMs = (d: Date) => d.getTime() + 9*3600_000;
  const fromJstMs = (ms: number) => new Date(ms - 9*3600_000);
  const j = new Date(toJstMs(nowUtc));
  const day0 = Date.UTC(j.getUTCFullYear(), j.getUTCMonth(), j.getUTCDate(), 0,0,0);
  const month0 = Date.UTC(j.getUTCFullYear(), j.getUTCMonth(), 1, 0,0,0);
  return {
    nowUtc,
    today:     { startUtc: fromJstMs(day0),    endUtc: nowUtc },
    yesterday: { startUtc: fromJstMs(day0-24*3600_000), endUtc: fromJstMs(day0) },
    thisMonth: { startUtc: fromJstMs(month0),  endUtc: nowUtc }
  };
}

function overlapSeconds(aStart: Date, aEnd: Date, bStart: Date, bEnd: Date) {
  const s = Math.max(aStart.getTime(), bStart.getTime());
  const e = Math.min(aEnd.getTime(),   bEnd.getTime());
  return Math.max(0, Math.floor((e - s)/1000));
}

Deno.serve(async (req) => {
  const url = new URL(req.url);
  const kid_id = url.searchParams.get("kid_id");
  if (!kid_id) return new Response("kid_id required", { status:400 });

  const ranges = jstRanges(new Date());
  const minStart = ranges.thisMonth.startUtc.toISOString();
  const maxEnd = new Date(Date.now() + 60_000).toISOString();

  // 関連するセッションを取得
  const { data: rows, error } = await supabase
    .from("sessions").select("label, started_at, ended_at")
    .eq("kid_id", kid_id)
    .lt("started_at", maxEnd)
    .or(`ended_at.gt.${minStart},started_at.gt.${minStart}`);
  if (error) return json({ ok:false, error:error.message }, 500);

  // 集計計算
  let today=0, yesterday=0, month=0;
  const now = new Date();
  for (const r of rows ?? []) {
    const s = new Date(r.started_at);
    const e = r.ended_at ? new Date(r.ended_at) : now;
    today     += overlapSeconds(s, e, ranges.today.startUtc,     ranges.today.endUtc);
    yesterday += overlapSeconds(s, e, ranges.yesterday.startUtc, ranges.yesterday.endUtc);
    month     += overlapSeconds(s, e, ranges.thisMonth.startUtc, ranges.thisMonth.endUtc);
  }

  // 現在の状態を取得
  let nowState: { label: string|null; since: string|null } = { label:null, since:null };
  const open = rows?.find(r => !r.ended_at);
  if (open) nowState = { label: open.label, since: open.started_at };

  return json({ ok:true, kid_id, now: nowState,
    totals:{ today_sec: today, yesterday_sec: yesterday, this_month_sec: month }});
});

function json(body: unknown, status=200) {
  return new Response(JSON.stringify(body), { status, headers:{ "content-type":"application/json" }});
}
```

## 6. 動作確認

### テストデータ作成
SQL Editor で子どもを追加：

```sql
-- 子どもを追加（id を控える）
insert into public.kids (display_name) values ('やすお君') returning id;
```

### API テスト（Windows環境）

❗ **Windows注意**: PowerShellの `curl` は別物（`Invoke-WebRequest`）です。Git Bash か `curl.exe` を使用してください。

**状態切替テスト:**
```bash
# 勉強を開始
curl -i -X POST "https://<project>.supabase.co/functions/v1/switch" \
  -H "Authorization: Bearer <ANON_KEY>" \
  -H "Content-Type: application/json" \
  --data '{"kid_id":"<KID_ID>","label":"study"}'

# 遊びに切替
curl -i -X POST "https://<project>.supabase.co/functions/v1/switch" \
  -H "Authorization: Bearer <ANON_KEY>" \
  -H "Content-Type: application/json" \
  --data '{"kid_id":"<KID_ID>","label":"play"}'
```

**統計取得テスト:**
```bash
curl -i -H "Authorization: Bearer <ANON_KEY>" \
  "https://<project>.supabase.co/functions/v1/stats?kid_id=<KID_ID>"
```

### 期待するレスポンス

**switch API:**
```json
{
  "ok": true,
  "current": {
    "label": "study",
    "started_at": "2025-09-08T12:34:56.789Z"
  }
}
```

**stats API:**
```json
{
  "ok": true,
  "kid_id": "uuid",
  "now": {
    "label": "study",
    "since": "2025-09-08T12:34:56.789Z"
  },
  "totals": {
    "today_sec": 3600,
    "yesterday_sec": 5400,
    "this_month_sec": 43200
  }
}
```

## 7. よくあるエラーと対処法

### Functions Secrets エラー
- ❗ `SUPABASE_URL` → `DB_URL` に変更
- ❗ `SUPABASE_SERVICE_ROLE_KEY` → `SERVICE_ROLE_KEY` に変更
- Functions の再デプロイが必要

### API エラー
- **409 エラー**: 同一ラベルへの60秒以内の連打ガード
- **400 エラー**: JSON形式エラー、または不正なlabel値
- **404 エラー**: エンドポイントが `/functions/v1/<name>` になっているか確認

### 認証エラー
- `Authorization: Bearer <ANON_KEY>` ヘッダーが必要
- service_role key はフロントで使用禁止

## 8. フロントエンド用環境変数

プロジェクトルートの `.env` ファイル:

```env
VITE_SUPABASE_URL=https://xxxx.supabase.co
VITE_SUPABASE_ANON_KEY=<anon key>
VITE_LABEL_STUDY=勉強
VITE_LABEL_PLAY=遊び
VITE_LABEL_BREAK=休憩
VITE_TZ=Asia/Tokyo
```

❗ **重要**: service_role key と Pushover tokens は Functions Secrets のみに置き、フロントでは使用しないこと。

## 9. セキュリティ設定

### RLS ポリシー（詳細版）
管理画面構築時に以下のポリシーを追加:

```sql
-- kids テーブル: 管理者のみアクセス
create policy "Admin can manage kids" on public.kids
  for all using (auth.role() = 'service_role');

-- sessions テーブル: 子端末は自分のkid_idのみアクセス可
create policy "Kids can manage own sessions" on public.sessions
  for all using (
    auth.role() = 'service_role' or 
    kid_id in (select id from public.kids where pin = auth.jwt()->>'pin')
  );
```

## 10. デプロイメント

### Cloudflare Pages / Vercel
1. GitHub リポジトリにプッシュ
2. プラットフォームで環境変数を設定:
   - `VITE_SUPABASE_URL`
   - `VITE_SUPABASE_ANON_KEY`
3. ビルドコマンド: `npm run build`
4. 出力ディレクトリ: `dist` (SvelteKit)

### PWA 設定確認
- `manifest.json` の設定
- Service Worker の登録
- iOS用metaタグ

---

## まとめ

この手順で以下が完成します:

- ✅ Supabase バックエンド（DB + Edge Functions）
- ✅ 状態切替API（連打ガード付き）
- ✅ 統計取得API（JST基準の今日/昨日/今月）
- ✅ Pushover 通知連携
- ✅ セキュリティ設定（RLS）

フロントエンド実装は SvelteKit + PWA で構築し、この API を呼び出します。